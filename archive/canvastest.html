<html>
<head>
    <script src="https://www.google.com/jsapi?key=ABQIAAAAILPShughClO5gcq-8OtmDRQNj39AWSBq-QEua0qmS9N6Sr1xuhQM3bpLoN1U6bG8KZpnh133uixqTg" type="text/javascript"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>    
    <script src="json2.js" type="text/javascript"></script>     
    <script src="date.js" type="text/javascript"></script> 
    <script src="jquery.getUrlParam.js" type="text/javascript"></script>
    
    <script language="Javascript" type="text/javascript">
    //<![CDATA[

        try { console.log('Firebug console found.'); } catch(e) { console = { log: function() {} }; }
        
        $(document).ready(checkForCanvas);
        $(document).ready(serverTimeReceived);
        $(document).ready(drawBox);
        $(document).ready(registerBtnListener);
        $(document).ready(replay);
        window.setInterval(showOthers, 3000);
        
        var offset = 0;
        var allClicks = [];
        var colorMap = new Array();        
        function Click(x, y, time) {
            this.x = x;
            this.y = y;
            this.time = time;
        }
    
        function drawBox() {
            var canvas = document.getElementById('c');
            
            var rob = new Image();
            rob.src = "http://groups.csail.mit.edu/haystack/realtime/rob-outline.png";
            rob.onload = function() {
               canvas.getContext("2d").drawImage(rob, 0, 0);
            }
            
            canvas.addEventListener("click", getClickLocation, false);
        }
        
        function getClickLocation(e) {
            var canvas = document.getElementById('c');
            var x;
            var y;
            if (e.pageX || e.pageY) { 
              x = e.pageX;
              y = e.pageY;
            }
            else { 
              x = e.clientX + document.body.scrollLeft + document.documentElement.scrollLeft; 
              y = e.clientY + document.body.scrollTop + document.documentElement.scrollTop; 
            } 
            x -= canvas.offsetLeft;
            y -= canvas.offsetTop;
            
            drawClick(x, y, "#00F");
            
            var serverNow = getServerTime();           
            
            allClicks.push(new Click(x, y, serverNow.toISOString()));
        }
        
        function drawClick(x, y, color) {
            var canvas = document.getElementById('c');        
            var context = canvas.getContext("2d")
            context.fillStyle = color;
            context.fillRect(x, y, 8, 8);
        }
        
        function serverTimeReceived() {
            var startTime = new Date();
            $.get("http://needle.csail.mit.edu/realtime/time.cgi",
                function(data) {
                    var unixSecs = parseInt(data.date.split('.')[0])
                    var unixMillis = (parseInt(data.date.split('.')[1]) / 1000);
                    
                    var travelTime = (new Date() - startTime)/2;                
                    var serverTime = (new Date(unixSecs)).addMilliseconds(unixMillis);
                    serverTime.addMilliseconds(travelTime);
                    offset = (serverTime - new Date());
                    console.log("offset: " + offset);
                });
        }
        
        function getServerTime() {
            return (new Date().addMilliseconds(offset));
        }
        
        function registerBtnListener() {
            var assignmentID = $(document).getUrlParam("assignmentId");
            if (assignmentID == null || assignmentID == "ASSIGNMENT_ID_NOT_AVAILABLE") {
                $('#donebtn').attr("disabled", "true").html("Accept HIT to submit work");
            } else {
                $('#donebtn').click(notify);
            }
        }
        
        function notify() {
            console.log(allClicks);
            var assignmentID = $(document).getUrlParam("assignmentId");
            var taskID = $(document).getUrlParam("task");

            $.post('http://needle.csail.mit.edu/realtime/canvastest.cgi',
                    { 'clicks': JSON.stringify(allClicks),
                      'assignmentId': assignmentID,
                      'taskId': taskID },
                    function(data) {
                        $('#completeForm').append('<input type="hidden" name="assignmentId" value="' + assignmentID + '" />')
                        .append('<input type="hidden" name="taskId" value="' + taskID + '" />')
                        .submit();
                    });
        }
        
        function replay() {
            var replay = $(document).getUrlParam("replay");
            var taskId = $(document).getUrlParam("task");
            if (replay == "1") {
                $.get('http://needle.csail.mit.edu/realtime/replay.cgi?task=' + taskId,
                    function(data) {
                        data.sort(function(a, b) { return a.clicktime - b.clicktime });
                        
                        // first figure out colors
                        $.map(data, function(elem, index) {
                            if (colorMap[elem.assignmentId] == null) {
                                colorMap[elem.assignmentId] = get_random_color();
                            }
                        });
                        
                        var functionGenerator = function(click) { return function() {
                            drawClick(click.x, click.y, colorMap[click.assignmentId]);
                        }};                    
                        
                        for(var i=0; i<data.length; i++) {
                            var click = data[i];                         
                            var waitTime = (click.clicktime - data[0].clicktime) * 1000;
                            
                            window.setTimeout(functionGenerator(click), waitTime);
                        }
                    });
            }
        }
        
        function showOthers() {
            var taskId = $(document).getUrlParam("task");
            var replay = $(document).getUrlParam("replay");
            if (replay != "1") {
                $.get('http://needle.csail.mit.edu/realtime/replay.cgi?task=' + taskId,
                    function(data) {
                        // prime them
                        var starterPoints = [
                            new Click(85, 204, 0),
                            new Click(77, 211, 0),
                            new Click(70, 222, 0),
                            new Click(69, 240, 0),
                            new Click(67, 255, 0),
                            new Click(169, 107, 0),
                            new Click(167, 97, 0),
                            new Click(167, 85, 0),
                            new Click(167, 68, 0)
                        ];
                        for(var i=0; i<starterPoints.length; i++) {
                            var click = starterPoints[i];                         
                            drawClick(click.x, click.y, "00F");
                        }
                    
                        // first figure out colors
                        $.map(data, function(elem, index) {
                            if (colorMap[elem.assignmentId] == null) {
                                colorMap[elem.assignmentId] = get_random_color();
                            }
                        });
                        
                        for(var i=0; i<data.length; i++) {
                            var click = data[i];                         
                            drawClick(click.x, click.y, colorMap[click.assignmentId]);
                        }
                    });
            }
        }
        
        function get_random_color() {
            var letters = '0123456789ABCDEF'.split('');
            var color = '#';
            for (var i = 0; i < 6; i++ ) {
                color += letters[Math.round(Math.random() * 15)];
            }
            return color;
        }
        
        function hasCanvas() {
            // http://diveintohtml5.org/detect.html#canvas
            return !!document.createElement('canvas').getContext;        
        }
        
        function checkForCanvas() {
            if (!hasCanvas()) {
                $('.real').remove();
                $('body').append("This HIT requires a browser that supports the Canvas element, like Safari, Chrome, Firefox or IE9. Your browser does not appear to support Canvas. Please return the HIT.");
            }
        }

    //]]>        
    </script>
</head>
<body>
    <div class="real">
        <div style="width: 400px; margin-bottom: 20px;">The blue outline shows what a <u>bad</u> algorithm tried to outline when a user clicked on the picture of the person. Click on the image below to draw where the outline <u>should be</u>. You may see other Turkers' working at the same time.</div>
        <canvas id="c" width=240 height=320 style="margin-bottom: 20px"></canvas>
        <div><button id="donebtn">I'm done.</button></div>
        
        <form id="completeForm" action="http://www.mturk.com/mturk/externalSubmit" method="POST" style="display: none">
            <input type="submit" name="done" value="done"></input>
        </form>
    </div>
    
</body>
</html>